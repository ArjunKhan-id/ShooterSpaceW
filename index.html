<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no" />
<title>ShooterSpaceW - Login / Register</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Poppins:wght@400;600&display=swap');
  * {
    box-sizing: border-box;
  }
  body {
    margin: 0;
    background: linear-gradient(135deg, #0f2027, #203a43, #2c5364);
    font-family: 'Poppins', sans-serif;
    color: #f0f0f0;
    height: 100vh;
    display: flex;
    justify-content: center;
    align-items: center;
  }
  #container {
    background: rgba(15,15,15,0.85);
    border-radius: 15px;
    box-shadow: 0 8px 30px rgba(0,0,0,0.6);
    width: 320px;
    padding: 30px 30px 40px;
    max-height: 600px;
    overflow-y: auto;
  }
  h2 {
    text-align: center;
    font-weight: 600;
    margin-bottom: 25px;
    letter-spacing: 1.1px;
    text-transform: uppercase;
    color: #00ffd8;
  }
  label {
    display: block;
    margin-bottom: 6px;
    font-weight: 500;
    font-size: 0.9rem;
    color: #a0f9f3;
  }
  .input-wrapper {
    position: relative;
    display: flex;
    align-items: center;
    margin-bottom: 18px;
  }
  input[type="text"],
  input[type="email"],
  input[type="password"],
  input[type="number"] {
    width: 100%;
    padding: 10px 40px 10px 14px; /* padding-right for icon space */
    border: none;
    border-radius: 6px;
    background-color: #142c34;
    color: #d9faff;
    font-size: 1rem;
    transition: background-color 0.3s;
  }
  input[type="text"]:focus,
  input[type="email"]:focus,
  input[type="password"]:focus,
  input[type="number"]:focus {
    outline: none;
    background-color: #1e434c;
  }
  .password-toggle {
    position: absolute;
    right: 12px;
    cursor: pointer;
    width: 24px;
    height: 24px;
    fill: #a0f9f3;
    user-select: none;
  }
  button {
    position: relative;
    width: 100%;
    background: #00ffd8;
    color: #0b2a2f;
    font-weight: 600;
    font-size: 1.1rem;
    padding: 12px;
    border: none;
    border-radius: 8px;
    cursor: pointer;
    margin-bottom: 15px;
    transition: background 0.3s;
    overflow: hidden;
  }
  button:hover:not(:disabled) {
    background: #00c9b1;
  }
  button:disabled {
    background: #555;
    cursor: not-allowed;
  }
  #toggle-form {
    background: transparent;
    color: #00ffd8;
    border: none;
    cursor: pointer;
    font-size: 0.9rem;
    text-decoration: underline;
    margin-top: 5px;
    width: 100%;
  }
  .otp-container {
    display: flex;
    gap: 10px;
    align-items: center;
    margin-bottom: 18px;
  }
  .otp-container input {
    flex-grow: 1;
    margin-bottom: 0;
  }
  .otp-container button {
    flex-grow: 0;
    width: 100px;
    padding: 10px;
    font-size: 0.9rem;
  }
  /* Spinner styling */
  .spinner {
    width: 18px;
    height: 18px;
    border: 3px solid rgba(11,42,47, 0.3);
    border-top-color: #0b2a2f;
    border-radius: 50%;
    animation: spin 1s linear infinite;
    position: absolute;
    top: calc(50% - 9px);
    left: calc(50% - 9px);
    display: none;
  }
  button.loading .spinner {
    display: block;
  }
  button.loading span {
    visibility: hidden;
  }
  @keyframes spin {
    to { transform: rotate(360deg); }
  }
  @media (max-width: 400px) {
    #container {
      width: 95vw;
      max-height: 580px;
      padding: 25px 20px 30px;
    }
  }
</style>

<!-- SweetAlert2 CSS -->
<link href="https://cdn.jsdelivr.net/npm/sweetalert2@11/dist/sweetalert2.min.css" rel="stylesheet" />

</head>
<body>

<div id="container">
  <h2 id="form-title">Register ShooterSpaceW</h2>
  <form id="auth-form" novalidate>
    <label for="username" id="label-username">Username</label>
    <input type="text" id="username" autocomplete="username" minlength="3" maxlength="20" placeholder="Your username" />

    <label for="email">Email</label>
    <div class="input-wrapper">
      <input type="email" id="email" autocomplete="email" placeholder="email@example.com" />
    </div>

    <label for="password">Password</label>
    <div class="input-wrapper">
      <input type="password" id="password" autocomplete="new-password" minlength="6" placeholder="Password (min 6 chars)" />
      <svg id="toggle-password" class="password-toggle" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" tabindex="0" aria-label="Toggle password visibility" role="button">
        <path d="M12 4.5C7 4.5 2.73 7.61 1 12c1.73 4.39 6 7.5 11 7.5s9.27-3.11 11-7.5c-1.73-4.39-6-7.5-11-7.5zm0 12c-2.49 0-4.5-2.01-4.5-4.5S9.51 7.5 12 7.5s4.5 2.01 4.5 4.5-2.01 4.5-4.5 4.5zm0-7a2.5 2.5 0 0 0 0 5 2.5 2.5 0 0 0 0-5z"/>
      </svg>
    </div>

    <div class="otp-container">
      <label for="otp" style="margin-bottom:6px; color:#a0f9f3; font-weight:500; font-size:0.9rem;">Enter OTP</label>
      <input type="number" id="otp" placeholder="6-digit OTP" maxlength="6" />
      <button type="button" id="send-otp-btn">Send OTP</button>
    </div>

    <button type="submit" id="submit-btn"><span>Register</span><div class="spinner"></div></button>
  </form>

  <button id="toggle-form">Already have an account? Login</button>
</div>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-app-compat.js"></script>
<script src="https://www.gstatic.com/firebasejs/9.22.2/firebase-auth-compat.js"></script>

<!-- EmailJS SDK -->
<script src="https://cdn.jsdelivr.net/npm/emailjs-com@3/dist/email.min.js"></script>

<!-- SweetAlert2 JS -->
<script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>

<script>
  emailjs.init("ZMLQ7jZCVJi1ssffU");

  const firebaseConfig = {
  apiKey: "AIzaSyCLDqFv1kiOFG4xH8XR-lUyW_j-FbBp8aM",
  authDomain: "shooterspacew.firebaseapp.com",
  databaseURL: "https://shooterspacew-default-rtdb.firebaseio.com",
  projectId: "shooterspacew",
  storageBucket: "shooterspacew.firebasestorage.app",
  messagingSenderId: "780477534762",
  appId: "1:780477534762:web:26a98d067ebca133e8a953",
  measurementId: "G-CLTY47FSSZ"
};
  firebase.initializeApp(firebaseConfig);
  const auth = firebase.auth();

  const form = document.getElementById('auth-form');
  const usernameInput = document.getElementById('username');
  const emailInput = document.getElementById('email');
  const passwordInput = document.getElementById('password');
  const otpInput = document.getElementById('otp');
  const sendOtpBtn = document.getElementById('send-otp-btn');
  const submitBtn = document.getElementById('submit-btn');
  const submitBtnText = submitBtn.querySelector('span');
  const toggleFormBtn = document.getElementById('toggle-form');
  const formTitle = document.getElementById('form-title');
  const togglePasswordIcon = document.getElementById('toggle-password');

  let isLoginMode = false;
  let generatedOtp = null;
  let otpVerified = false;

  togglePasswordIcon.addEventListener('click', () => {
    if (passwordInput.type === "password") {
      passwordInput.type = "text";
      togglePasswordIcon.style.fill = "#00c9b1";
    } else {
      passwordInput.type = "password";
      togglePasswordIcon.style.fill = "#a0f9f3";
    }
  });

  function showSuccess(message) {
    Swal.fire({
      icon: 'success',
      title: 'Success',
      text: message,
      timer: 2500,
      showConfirmButton: false
    });
  }

  function showError(message) {
    Swal.fire({
      icon: 'error',
      title: 'Error',
      text: message,
    });
  }

  function validateEmail(email) {
    const re = /^[^\s@]+@[^\s@]+\.[^\s@]+$/;
    return re.test(email.trim());
  }

  function resetOtpState() {
    generatedOtp = null;
    otpVerified = false;
    otpInput.value = '';
    submitBtn.disabled = true;
  }

  function validateForm() {
    if (isLoginMode) {
      submitBtn.disabled = !(validateEmail(emailInput.value) && passwordInput.value.length >= 6);
    } else {
      submitBtn.disabled = !(usernameInput.value.trim().length >= 3 && validateEmail(emailInput.value) && otpVerified && passwordInput.value.length >= 6);
    }
  }

  function generateOtp() {
    return Math.floor(100000 + Math.random() * 900000).toString();
  }

  function sendOtpEmail(email, otp) {
    return emailjs.send('service_8fsbu8n', 'template_g46cxyi', {
      to_email: email.trim(),
      otp_code: otp,
    });
  }

  sendOtpBtn.addEventListener('click', () => {
    const email = emailInput.value.trim();
    if (!validateEmail(email)) {
      showError('Please enter a valid email address.');
      return;
    }
    generatedOtp = generateOtp();
    sendOtpBtn.disabled = true;
    sendOtpBtn.textContent = 'Sending...';

    sendOtpEmail(email, generatedOtp)
      .then(() => {
        showSuccess('OTP sent! Check your email.');
        sendOtpBtn.textContent = 'Resend OTP';
        validateForm();
      })
      .catch((err) => {
        console.error('EmailJS error:', err);
        showError('Failed to send OTP. Please try again later.');
        generatedOtp = null;
        sendOtpBtn.textContent = 'Send OTP';
      })
      .finally(() => {
        sendOtpBtn.disabled = false;
      });
  });

  otpInput.addEventListener('input', () => {
    if (!generatedOtp) {
      otpVerified = false;
      validateForm();
      return;
    }
    const userOtp = otpInput.value.trim();
    if (userOtp.length === 6) {
      if (userOtp === generatedOtp) {
        otpVerified = true;
        showSuccess('OTP verified successfully!');
      } else {
        otpVerified = false;
        showError('Invalid OTP. Please try again.');
      }
    } else {
      otpVerified = false;
    }
    validateForm();
  });

  toggleFormBtn.addEventListener('click', () => {
    isLoginMode = !isLoginMode;
    resetOtpState();
    form.reset();
    passwordInput.type = 'password';
    togglePasswordIcon.style.fill = "#a0f9f3";

    if (isLoginMode) {
      formTitle.textContent = 'Login ShooterSpaceW';
      usernameInput.style.display = 'none';
      otpInput.style.display = 'none';
      sendOtpBtn.style.display = 'none';
      submitBtnText.textContent = 'Login';
      toggleFormBtn.textContent = "Don't have an account? Register";
    } else {
      formTitle.textContent = 'Register ShooterSpaceW';
      usernameInput.style.display = 'block';
      otpInput.style.display = 'inline-block';
      sendOtpBtn.style.display = 'inline-block';
      submitBtnText.textContent = 'Register';
      toggleFormBtn.textContent = 'Already have an account? Login';
    }
    validateForm();
  });

  [usernameInput, emailInput, passwordInput, otpInput].forEach(input => {
    input.addEventListener('input', () => {
      validateForm();
    });
  });

  form.addEventListener('submit', (e) => {
    e.preventDefault();

    const username = usernameInput.value.trim();
    const email = emailInput.value.trim();
    const password = passwordInput.value;

    submitBtn.disabled = true;
    submitBtn.classList.add('loading');

    if (isLoginMode) {
      auth.signInWithEmailAndPassword(email, password)
      .then(userCredential => {
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
        showSuccess('Login successful! Redirecting...');
        setTimeout(() => {
          Swal.fire({
            icon: 'success',
            title: 'Welcome back!',
            text: `You are now logged in to ShooterSpaceW as ${userCredential.user.email}`,
            confirmButtonText: 'OK'
          }).then(() => {
            form.reset();
            resetOtpState();
          });
        }, 1500);
      })
      .catch(error => {
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
        switch (error.code) {
          case 'auth/user-not-found':
            showError('User not found. Please register first.');
            break;
          case 'auth/wrong-password':
            showError('Incorrect password. Please try again.');
            break;
          case 'auth/invalid-email':
            showError('Invalid email format.');
            break;
          default:
            showError(`Login error: ${error.message}`);
        }
      });
    } else {
      if (!otpVerified) {
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
        showError('Please verify OTP before registering.');
        return;
      }
      auth.createUserWithEmailAndPassword(email, password)
      .then(userCredential => {
        userCredential.user.updateProfile({ displayName: username }).then(() => {
          submitBtn.disabled = false;
          submitBtn.classList.remove('loading');
          showSuccess('Registration successful! You can now login.');
          form.reset();
          resetOtpState();
          toggleFormBtn.click();
        });
      })
      .catch(error => {
        submitBtn.disabled = false;
        submitBtn.classList.remove('loading');
        switch (error.code) {
          case 'auth/email-already-in-use':
            showError('Email already in use. Please login.');
            break;
          case 'auth/invalid-email':
            showError('Invalid email format.');
            break;
          case 'auth/weak-password':
            showError('Weak password. Minimum 6 characters.');
            break;
          default:
            showError(`Registration error: ${error.message}`);
        }
      });
    }
  });

  toggleFormBtn.click();  // initialize in register mode

</script>
<script>
  const form = document.getElementById('loginForm');

  form.addEventListener('submit', function(e) {
    e.preventDefault(); // Biar nggak reload dulu

    // logika login, misalnya validasi Firebase, dll
    // kalau sukses:
    window.location.href = 'dashboard.html';
  });
</script>

</body>
</html>